<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1020" />
  <title>Upbit 기반 Top 10 매수 유망 코인</title>
  <style>
    :root{
      --bg:#0b1020;--card:#121934;--muted:#9fb0ff;--text:#e8ecff;
      --good:#2ecc71;--bad:#ff5e6b;--border:rgba(255,255,255,.1);
      --accent:#6c8bff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;background:linear-gradient(180deg,#0b1020,#090e1d 40%,#0b1020);color:var(--text)}
    header{position:sticky;top:0;background:rgba(11,16,32,.85);border-bottom:1px solid var(--border);backdrop-filter:blur(10px);text-align:center;padding:10px 0}
    .wrap{max-width:1200px;margin:0 auto;padding:14px}
    h1{font-size:24px;margin:4px 0;display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap}
    .badge{background:linear-gradient(180deg,var(--accent),#4f6df8);padding:4px 10px;border-radius:999px;font-size:11px;font-weight:800;color:#fff}
    .date-today{font-size:20px;font-weight:600;color:var(--muted);margin:4px 0}
    .sub{font-size:13px;color:var(--muted)}
    .refresh-btn{margin-top:8px;padding:6px 14px;font-size:13px;font-weight:600;background:var(--accent);color:#fff;border:none;border-radius:8px;cursor:pointer}
    .refresh-btn:hover{opacity:0.9}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:14px;margin-top:16px}
    .card{background:#121934;border:1px solid var(--border);border-radius:14px;box-shadow:0 4px 12px rgba(0,0,0,.3);padding:16px;display:flex;flex-direction:column;gap:8px;transition:transform .2s}
    .card:hover{transform:translateY(-2px)}
    .coin-header{display:flex;align-items:center;justify-content:space-between}
    .coin-info{display:flex;align-items:center;gap:10px}
    .coin-info img{width:28px;height:28px;border-radius:50%}
    .coin-name{font-weight:700;font-size:15px}
    .coin-symbol{font-size:12px;color:var(--muted)}
    .stat{display:flex;justify-content:space-between;font-size:13px}
    .chip{padding:3px 6px;border-radius:6px;font-size:12px;font-weight:600}
    .chip.good{background:rgba(46,204,113,.15);color:var(--good)}
    .chip.bad{background:rgba(255,94,107,.15);color:var(--bad)}
    .scorebar{height:10px;border-radius:6px;background:#0d1430;border:1px solid var(--border);overflow:hidden;margin-top:4px}
    .scorebar>i{display:block;height:100%;background:linear-gradient(90deg,#5f7cff,#2ae59b);width:0%}
    .muted{color:var(--muted);font-size:12px}
    .reason{margin-top:4px;line-height:1.5}
    footer{font-size:12px;color:var(--muted);padding:14px 0 30px;text-align:center;margin-top:20px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>요한 추천 오늘 매수 유망 코인 <span class="badge">Top 10</span></h1>
      <div class="date-today" id="today"></div>
      <div class="sub">Upbit Open API (KRW 마켓) 데이터 기반 · 금일 <b>상승 확률(%)</b> Top 10</div>
      <div class="status" id="status"><span class="dot" id="dot"></span> <span id="statusText">준비</span></div>
      <button class="refresh-btn" id="refreshBtn">🔄 새로고침</button>
    </div>
  </header>
  <main class="wrap">
    <div class="grid" id="cards"></div>
  </main>
  <footer>© <span id="year"></span> — 아직도 이더리움 안산 흑두리미들 없제?</footer>
<script>
(async function(){
  const qs=s=>document.querySelector(s);
  const $cards=qs('#cards'); const $status=qs('#statusText'); const $dot=qs('#dot'); const $refresh=qs('#refreshBtn');
  function setStatus(ok,msg){$status.textContent=msg;$dot.className='dot '+(ok?'ok':'err');}
  const nfKRW=v=> new Intl.NumberFormat('ko-KR',{style:'currency',currency:'KRW',maximumFractionDigits:0}).format(v);
  const pf=v=> (isFinite(v)? ((v>=0?'+':'')+(v*100).toFixed(2)+'%') : '–');
  const ppct=v=> (isFinite(v)? (v.toFixed(1)+'%') : '–');
  const clamp=(v,min,max)=>Math.min(max,Math.max(min,v));
  const PROXY_BASE = "https://upbitapi.didiradira.workers.dev";

  async function fetchKRWMarkets(){
    const url = `${PROXY_BASE}/api/upbit/market-all`;
    const res = await fetch(url, { headers: { accept: 'application/json' } });
    if(!res.ok) throw new Error('마켓 목록 오류 '+res.status);
    const all = await res.json();
    return all.filter(m=>m.market.startsWith('KRW-'));
  }
  async function fetchTickers(markets){
    const url = `${PROXY_BASE}/api/upbit/ticker?markets=${encodeURIComponent(markets.join(','))}`;
    const res = await fetch(url, { headers: { accept: 'application/json' } });
    if(!res.ok) throw new Error('티커 오류 '+res.status);
    return res.json();
  }
  function percentile(arr,val){
    const vals=arr.filter(x=>Number.isFinite(x)).slice().sort((a,b)=>a-b);
    if(!vals.length) return 0;
    let lo=0,hi=vals.length;
    while(lo<hi){const m=(lo+hi)>>1; if(vals[m]<=val) lo=m+1; else hi=m;}
    return lo/vals.length;
  }

  // --- 상승 근거 생성기 ---
  function buildReason(r, ctx){
    const parts=[];
    // 1) 거래대금 상위 (상위 20%)
    if (ctx.pL >= 0.8) parts.push("거래대금 상위(상위 20%)로 수급 유입");
    // 2) 당일 고가 근접/돌파 모멘텀
    if (r.proxHigh >= 0.97 && r.change_rate > 0) parts.push("고가권 근접·양봉 흐름(돌파/안착 모멘텀)");
    // 3) 단기 상승률 모멘텀
    if (r.change_rate >= 0.02) parts.push(`단기 상승률 +${(r.change_rate*100).toFixed(1)}%로 모멘텀 유효`);
    // 4) 변동성 안정(낮을수록 우상향 유리) — 하위 30%
    if (ctx.pV <= 0.3) parts.push("변동성 안정화로 추세 우상향 유리");
    // 5) 대체 시나리오: 거래대금↑ + 음봉 → 수급 유지 속 조정
    if (parts.length===0 && ctx.pL>=0.8 && r.change_rate<0) parts.push("거래대금 상위 유지, 단기 조정 속 수급 지속");
    // 6) 최소 한 줄 보장
    if (parts.length===0) parts.push("거래대금 양호 및 기술적 반등 가능성");
    // 상위 2~3개로 간결히
    return `상승할 근거 : ${parts.slice(0,3).join(", ")}`;
  }

  async function run(){
    try{
      setStatus(true,'Upbit 데이터 불러오는 중…');
      const markets=await fetchKRWMarkets();
      const codes=markets.map(m=>m.market);
      const chunks=[]; for(let i=0;i<codes.length;i+=100){chunks.push(codes.slice(i,i+100));}
      let rows=[];
      for(const part of chunks){
        const tks=await fetchTickers(part);
        rows=rows.concat(tks.map(t=>{
          const meta=markets.find(m=>m.market===t.market)||{};
          const proxHigh=(t.high_price&&t.low_price&&t.trade_price)?((t.trade_price-t.low_price)/Math.max(1e-9,(t.high_price-t.low_price))):0;
          const volatility=(t.high_price&&t.low_price&&t.trade_price)?((t.high_price-t.low_price)/Math.max(1e-9,t.trade_price)):0;
          return {
            market:t.market,
            name_kr:meta.korean_name||t.market,
            price:t.trade_price,
            change_rate:t.signed_change_rate||0,
            vol24:t.acc_trade_price_24h||0,
            proxHigh, volatility
          };
        }));
      }

      // 전체 분포로 백분위 구해 점수 산출
      const arrChange=rows.map(r=>r.change_rate);
      const arrHigh=rows.map(r=>r.proxHigh);
      const arrLiq=rows.map(r=>r.vol24);
      const arrVol=rows.map(r=>r.volatility);

      rows=rows.map(r=>{
        const pC=percentile(arrChange,r.change_rate); // 상승률 백분위
        const pH=percentile(arrHigh,r.proxHigh);      // 고가 근접도 백분위
        const pL=percentile(arrLiq,r.vol24);          // 거래대금 백분위
        const pV=percentile(arrVol,r.volatility);     // 변동성 백분위(낮을수록 좋게 반영)

        // 종합 점수 → 시그모이드 확률
        const score=0.5*pC+0.2*pH+0.25*pL+0.1*(1-pV);
        const k=5;
        const riseProb = 100*(1/(1+Math.exp(-k*(score-0.5))));

        // 상승 근거 생성
        const reason = buildReason(r, {pC,pH,pL,pV});

        return {...r, riseProb, reason};
      })
      .sort((a,b)=>b.riseProb-a.riseProb)
      .slice(0,10);

      $cards.innerHTML=rows.map((r,i)=>{
        const cls24=(r.change_rate||0)>=0?'good':'bad';
        const bar=clamp(r.riseProb,0,100).toFixed(1);
        return `<div class="card">
          <div class="coin-header">
            <div class="coin-info">
              <img src="https://static.upbit.com/logos/${r.market.replace('KRW-','')}.png" onerror="this.style.display='none'" alt="${r.market}">
              <div>
                <div class="coin-name">${r.name_kr}</div>
                <div class="coin-symbol">${r.market}</div>
              </div>
            </div>
            <div class="rank">#${i+1}</div>
          </div>
          <div class="stat"><span>가격</span><span>${nfKRW(r.price)}</span></div>
          <div class="stat"><span>24h 변화</span><span class="chip ${cls24}">${pf(r.change_rate)}</span></div>
          <div class="stat"><span>24h 거래대금</span><span>${nfKRW(r.vol24)}</span></div>
          <div class="stat"><span>고가 근접도</span><span>${(r.proxHigh*100).toFixed(0)}%</span></div>
          <div class="stat"><span>오늘 상승 확률</span><span>${ppct(r.riseProb)}</span></div>
          <div class="scorebar"><i style="width:${bar}%"></i></div>
          <div class="muted reason">${r.reason}</div>
        </div>`;
      }).join('');

      setStatus(true,'파싱완료. 아직도 이더리움 안산 흑두루미 없제?');
    }catch(e){
      console.error(e);
      setStatus(false,'오류: '+e.message);
    }
  }

  const today=new Date();
  qs('#today').textContent=today.getFullYear()+"-"+(today.getMonth()+1).toString().padStart(2,'0')+"-"+today.getDate().toString().padStart(2,'0');
  qs('#year').textContent=new Date().getFullYear();
  qs('#refreshBtn').addEventListener('click', run);
  run();
})();
</script>
</body>
</html>
